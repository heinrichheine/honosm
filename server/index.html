<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>
    </title>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.css"/>
    <style>
            /* App custom styles */
    </style>
    <script src="/jquery-1.7.1.js"></script>
    <script src="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.js"></script>
    <script src="http://www.openlayers.org/api/OpenLayers.js"></script>

    <script type="text/javascript" language="javascript">

        var currentLat;
        var currentLon;
        var watchId;
        
        
                
        /*
         * streetData is a JSON object of pairs of streetname:streetId
         */
        function updateStreetSelector(streetData) {
            
            $("#streetselect").empty();
            streets = "";
            var firstStreetSet = 0;
            for (var street in streetData.name) {
                var streetId = streetData[street];
                streets += street + "<br/> ";
                if ( firstStreetSet == 0) {
                    $("#streetselect").append('<option value="' + streetId+'">'+street+'</option>');
                    $("#streetselect").val(streetId);
                    firstStreetSet = 1;
                } else {
                    $("#streetselect").append('<option value="' + streetId+'">'+street+'</option>');
                }
            }
            $("#streetselect").selectmenu("refresh");

            $("#currentPosition").html("Streets:<br/> " + streets);        
        }
        
        function getStreet(lat, lon) {
            // send position to server to get the streetname
            var posRequest = $.ajax({
                url:"getstreetname?lat=" + lat + "&lon=" + lon,
                type:"GET",
                dataType:"json",
                success:function (data) {
                     
                    updateStreetSelector(data) 
                },
                error:function () {
                    alert("error")
                }
            });
        }
        
        function updateMapImage(lat, lon) {
            
            var lonlat = new OpenLayers.LonLat( lon, lat );
            lonlat.transform( new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject() );
                        
            var currentPositionMarker = new OpenLayers.Marker(lonlat, icon);
            markers.addMarker(currentPositionMarker);
           
            map.setCenter( lonlat, 18 );
            
        }

        function error(msg) {
            console.log(typeof msg == 'string' ? msg : msg.code);
            $("#currentPosition").html("error code: " + msg.code);
        }

        function success(position) {

            navigator.geolocation.clearWatch(watchId);
            currentLat = position.coords.latitude;
            currentLon = position.coords.longitude;

            $("#currentPosition").html("lat: " + currentLat + "<br/>lon: " + currentLon);
            console.log(position.coords.latitude);
            console.log(position.coords.longitude);

            getStreet(currentLat, currentLon);
            updateMapImage(currentLat, currentLon);
        }


        function gatherPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.clearWatch(watchId);
                
               for (var i = 0; i <= 20; i++) 
                    navigator.geolocation.watchPosition(function() {}, function() {},
                        {
                            enableHighAccuracy: true,
                            timeout: 60000,
                            maximumAge: 0
                        });
               /*     navigator.geolocation.getCurrentPosition({
                            enableHighAccuracy: true,
                            timeout: 60000,
                            maximumAge: 0
                        });
                */
                console.log("start watch gps");
                watchId = navigator.geolocation.watchPosition(success, error,
                        {
                            enableHighAccuracy: true,
                            timeout: 60000,
                            maximumAge: 0
                        });

            }
        }


        $(document).ready(function () {
            $.mobile.loadingMessage = "Determine position";

            $("#buttonGPS").click(gatherPosition);
        });
    </script>
</head>
<body>
<div data-role="page" id="mappage">
    <div data-theme="e" data-role="header">
        <h3>
            HonOSM
        </h3>
        <a id="buttonGPS" data-role="button" data-inline="true" href="" data-icon="gear" data-iconpos="left">
            Track
        </a>
    </div>

    <div data-role="content">
        <form action="">
            <div data-role="fieldcontain">
                <fieldset data-role="controlgroup">
                    <label for="textinput2">
                        Housenumber
                    </label>
                    <input id="textinput2" placeholder="" value="" type="text" />
                </fieldset>
            </div>
            <div data-role="fieldcontain">
                <label for="selectmenu1">
                    Street
                </label>
                <select name="streetselect" id="streetselect" data-theme="e" data-mini="true">
                </select>
            </div>
            <input value="Save Housenumber" type="submit" />
        </form>
       </div>
    <h4>
        Current Position
    </h4>

    <div id="currentPosition">
        unknown
    </div>
    <div id="demoMap" style="height:350px; width:100%;"></div>
    <script>
        var map = new OpenLayers.Map("demoMap");
        map.addLayer(new OpenLayers.Layer.OSM());        
        var markers = new OpenLayers.Layer.Markers( "Markers" );
        
        var size = new OpenLayers.Size(21,25);
        var offset = new OpenLayers.Pixel(-11, -12);
        var icon = new OpenLayers.Icon('http://www.openlayers.org/dev/img/marker.png', size, offset);
        
        map.addLayer(markers);

        
        
        map.zoomToMaxExtent();
    </script>
    </div>



    
</div>
<script>
    //App custom javascript
</script>
</body>
</html>
